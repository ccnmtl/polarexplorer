{% extends "base.html" %}

{% block title %}
    Calving Glacier
{% endblock %}

{% block extrahead %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script type="text/javascript">
        gImageCount = 8;
        gPreloadedImages = new Array(gImageCount + 1);
        for (var i=0; i < gImageCount; i++) {
            gPreloadedImages[i] = new Image();
            gPreloadedImages[i].src = '/site_media/img/glacier/' + (i+1) + '.png';    
        }
        gPreloadedImages[gImageCount] = new Image();
        gPreloadedImages[gImageCount].src = '/site_media/img/glacier/water.png'
    </script>
{% endblock %}


{% block content %}
    <div data-role="page">
        <div data-role="header" id="base-header">
            <a id="about-button" href="#about" data-role="button" data-rel="dialog" data-icon="info">About</a>
            <h1 id="header">Calving Glacier</h1>
            <a id="reset-button" href="#" data-role="button" data-icon="refresh">Reset</a>
        </div>

        <div id="base-content" data-role="content" style="display: none">
            <div class="ui-grid-solo">
                <div class="ui-block-a pageview glacierview">
                    <div class="ui-overlay">
                    <img class="helptext macromap" src="/site_media/img/help/help_calving_map.png" />
                    <img class="helptext pageview" src="/site_media/img/help/help_calving_interactive.png" />
                    </div>
                                        
                    <img id="glacier-chunk" src="/site_media/img/glacier/chunk.png" style="display: none;"/>
                    <canvas class="explosion" width="200" height="200"
                        onmousedown="dropBomb(event, this)"></canvas>
                    
                    <img class="inset" src="/site_media/img/glacier_macro/1.png" alt="macromap" data-idx="1" />
                    <img class="inset" src="/site_media/img/glacier_macro/2.png" alt="macromap" data-idx="2" style="display: none;"/>
                    <img class="inset" src="/site_media/img/glacier_macro/3.png" alt="macromap" data-idx="3" style="display: none;"/>
                    <img class="inset" src="/site_media/img/glacier_macro/4.png" alt="macromap" data-idx="4" style="display: none;"/>
                    <img class="inset" src="/site_media/img/glacier_macro/5.png" alt="macromap" data-idx="5" style="display: none;"/>
                    <img class="inset" src="/site_media/img/glacier_macro/6.png" alt="macromap" data-idx="6" style="display: none;"/>
                    <img class="inset" src="/site_media/img/glacier_macro/7.png" alt="macromap" data-idx="7" style="display: none;"/>
                    <img class="inset" src="/site_media/img/glacier_macro/8.png" alt="macromap" data-idx="8" style="display: none;"/>                    
                    
                    <img class="glacier active" src="/site_media/img/glacier/1.png" alt="iceberg" data-idx="1" style="left: 0px;" />
                    <img class="glacier" src="/site_media/img/glacier/2.png" alt="iceberg" data-idx="2" style="display: none; opacity: 0;"/>
                    <img class="glacier" src="/site_media/img/glacier/3.png" alt="iceberg" data-idx="3" style="display: none; opacity: 0;"/>
                    <img class="glacier" src="/site_media/img/glacier/4.png" alt="iceberg" data-idx="4" style="display: none; opacity: 0;"/>
                    <img class="glacier" src="/site_media/img/glacier/5.png" alt="iceberg" data-idx="5" style="display: none; opacity: 0;"/>
                    <img class="glacier" src="/site_media/img/glacier/6.png" alt="iceberg" data-idx="6" style="display: none; opacity: 0;"/>
                    <img class="glacier" src="/site_media/img/glacier/7.png" alt="iceberg" data-idx="7" style="display: none; opacity: 0;"/>
                    <img class="glacier" src="/site_media/img/glacier/8.png" alt="iceberg" data-idx="8" style="display: none; opacity: 0;"/>
                    
                    <img class="water" src="/site_media/img/glacier/water.png" alt="water" />
                </div>
            </div>
        </div>
        
        <div data-role="footer"></div>
    </div>

{% endblock %}

{% block js %}
    <script type="text/javascript" src="/site_media/js/jquery.easing.1.3.js"></script>
    <script type="text/javascript" src="/site_media/js/explode.js" /></script>
    <script type="text/javascript" src="/site_media/js/util.js" /></script>

    <script type="text/javascript">
        var gEaseOut = 1000;
        var gEaseIn = 1800;

        function setWaterLevel(imgIdx, duration) {
            if (imgIdx === undefined) {            
                var elt = jQuery("img.glacier.active")[0];
                imgIdx = parseInt(jQuery(elt).data("idx"), 10);
            }
            if (duration === undefined) {
                duration = 0;
            }
            
            var level = 80.75;
            var increment = .95 * imgIdx;            
            if (getOrientationLabel() == "landscape") {
                level = 78;
                increment = 2 * imgIdx;
            }

            var rise = level - increment;
            jQuery("img.water").animate({"top": rise + "%"},
                                        duration,
                                        "easeInSine");
        }
        
        function swipeGlacier() {
            explode(193, 106);

            var elt = jQuery("img.glacier.active")[0];
            var imgIdx = parseInt(jQuery(elt).data("idx"), 10);
            var newIdx = (imgIdx + 1) % (gImageCount + 1);
            
            if (imgIdx < gImageCount && newIdx > 0) {
                var newElt = jQuery("img.glacier[data-idx='" + newIdx + "']")[0];
                
                var left = parseInt(jQuery(elt).css("left"), 10);
                var newLeft = parseInt(jQuery(newElt).css("left"), 10);
                
                jQuery(newElt).show();
                jQuery(newElt).css({"left": (newLeft - 10) + "px"});
                
                jQuery(elt).removeClass("active");
                jQuery(newElt).addClass("active");
                
                jQuery(elt).animate(
                    {"left": (left - 10) + "px",
                     "opacity": 0,
                     "clip": "rect(0px,0px,0px,0px)"},
                    gEaseOut,
                    "easeInSine",
                    function() {
                        jQuery(elt).hide();
                        
                    });
                jQuery(newElt).animate({
                    "opacity": 1},
                    gEaseIn,
                    "easeInSine",
                    function() {});
                
                var macroElt = jQuery("img.inset[data-idx='" + imgIdx + "']")[0];
                var macroNewElt = jQuery("img.inset[data-idx='" + newIdx + "']")[0];
                
                jQuery(macroNewElt).fadeIn(gEaseOut);
                jQuery(macroElt).fadeOut(gEaseIn);
                setWaterLevel(imgIdx, gEaseIn)
                
                var left = parseInt(jQuery("canvas.explosion").css("left"), 10);
                jQuery("canvas.explosion").css({"left": left + (imgIdx * 2)});
            }
        }
        
        jQuery(document).on("pageinit", function (event) {
            if (getCookie("glacier-help-viewed")) {
                jQuery("div.ui-overlay").hide();
            }
            jQuery("div.ui-overlay").bind("tap", function() {
                jQuery("div.ui-overlay").hide();
                setCookie("glacier-help-viewed", true);
             });
            
            initExplosion(jQuery("#glacier-chunk")[0],
                          jQuery("canvas.explosion")[0]);

            function stopScrolling(evt) {
                if (evt.target.parentElement.className !== "ui-btn-inner") {
                    evt.preventDefault();
                }
            }
            document.addEventListener('touchstart', stopScrolling, false);
            document.addEventListener('touchmove', stopScrolling, false);
            
            jQuery("img").on('dragstart', function(event) {
                event.preventDefault();
                return false;
            });

            jQuery("img.glacier, img.inset").swipeleft(function(event) {
                event.stopImmediatePropagation();
                event.preventDefault();
                swipeGlacier();                
                return false;
            });
            jQuery("#reset-button").click(function() {
                jQuery("img.glacier.active").animate({'opacity': 0},
                    function() {
                        // deactivate active
                        jQuery(this).removeClass("active").hide();
                        
                        // all glacier's should have left: 10px;
                        jQuery("img.glacier").css({"left": "10px"});
                        
                        // except glacier with data-idx='1'
                        jQuery("img.glacier[data-idx='1']") 
                           .addClass("active")
                           .show()
                           .css({"left": "0px", "opacity": 1});                           
                        
                        jQuery("img.inset").hide();
                        jQuery("img.inset[data-idx='1']").show();
                        
                        setWaterLevel(0);
                });
                return false;  
            });
            
            jQuery(window).bind("orientationchange", function (e, ui) {
                document.body.scrollTop = document.documentElement.scrollTop = 0;
                setWaterLevel();               
            });
        });
    </script>
{% endblock %}

