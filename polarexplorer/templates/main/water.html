{% extends "base.html" %}

{% block title %}
    Rising water levels
{% endblock %}

{% block css %}
    {{ block.super }}
    <link href="/site_media/css/vslider.css" rel="stylesheet">
{% endblock %}

{% block extrahead %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <script type="text/javascript">
        gImageCount = 4;
        /* Preload Images */
    </script>
{% endblock %}


{% block content %}
    <div data-role="page" class="water">
        <div data-role="header" id="base-header">
            <a href="#about" data-role="button" data-rel="dialog" data-icon="info">About</a>
            <h1 id="header">Rising Water Levels</h1>
            <a id="reset" href="#" data-role="button" data-icon="refresh">Reset</a>
        </div>

        <div data-role="content">
            <div class="ui-grid-solo">
                <div class="ui-block-a pageview waterview">
                    <img class="inset active" src="/site_media/img/water/1.png" alt="macromap" data-idx="1" />
                    <img class="inset" src="/site_media/img/water/2.png" alt="macromap" data-idx="2" style="display: none;"/>
                    <img class="inset" src="/site_media/img/water/3.png" alt="macromap" data-idx="3" style="display: none;"/>
                    <img class="inset" src="/site_media/img/water/4.png" alt="macromap" data-idx="4" style="display: none;"/>
                
                    <input type="vrange" name="water" id="water"
                        data-highlight="true" min="0" max="100"
                        style="display: none;" />
                </div>
            </div>
        </div>
        
        <div data-role="footer"></div>
    </div>
    
{% endblock %}

{% block js %}    
    <script type="text/javascript">
        var gEaseOut = 1000;
        var gEaseIn = 1600;
        var ignoreChange = false;
        
        function getWaterLevel(imgIdx) {
            if (imgIdx === undefined) {       
                var elt = jQuery("img.inset.active")[0];
                imgIdx = parseInt(jQuery(elt).data("idx"), 10);
            }
            
            var defaultLevel = 45;
            var rise = defaultLevel - ((imgIdx - 1) * 6);
            if (getOrientationLabel() == "landscape") {
                defaultLevel = 68;
                rise = defaultLevel - ((imgIdx - 1) * 8);
            }
            return rise;          
        }

        function setWaterLevel(imgIdx, duration) {
            ignoreChange = true;
            jQuery("#water").attr("value", getWaterLevel(imgIdx));
            jQuery("#water").trigger("change");
            ignoreChange = false;
        }
        
        function swapImages(elt, newIdx) {
            var newElt = jQuery("img.inset[data-idx='" + newIdx + "']")[0];
            jQuery(newElt).addClass("active").fadeIn(gEaseOut);
            jQuery(elt).removeClass("active").fadeOut(gEaseIn);
        }
        
        function adjustMacroMap() {
            var value = jQuery("#water").attr("value");
            
            var elt = jQuery("img.inset.active")[0];
            imgIdx = parseInt(jQuery(elt).data("idx"), 10);
            var currentRise = getWaterLevel(imgIdx);
            
            if (value < currentRise && imgIdx > 1) {
                var newIdx = imgIdx - 1;
                swapImages(elt, newIdx);
            } else if (value > currentRise) {
                var newIdx = (imgIdx + 1) % (gImageCount + 1);
                if (imgIdx < gImageCount && newIdx > 0) {
                    var nextRise = getWaterLevel(newIdx);
                    if (value >= nextRise) {
                        swapImages(elt, newIdx);
                    }
                }
            }
        }
    
        jQuery(document).on("pageinit", function (event) {
            function stopScrolling(evt) {
                if (evt.target.className !== "inset active" &&
                        evt.target.parentElement.className !== "ui-btn-inner") {
                    evt.preventDefault();
                }
            }
            //document.addEventListener('touchstart', stopScrolling, false);
            //document.addEventListener('touchmove', stopScrolling, false);
            
            jQuery("#water").verticalslider();
            setWaterLevel(1);
            jQuery("#water").on("beforechange", function(evt, val) {
                if (val <= 42) {
                    return false;
                } else {
                    return true;
                }
            });
            jQuery("#water").bind("change", function() {
                if (!ignoreChange) {
                    adjustMacroMap();
                }
            });
            
            jQuery("img.inset").click(function(event) {
                event.preventDefault();
                var elt = jQuery("img.inset.active")[0];
                imgIdx = parseInt(jQuery(elt).data("idx"), 10);
                
                var newIdx = (imgIdx + 1) % (gImageCount + 1);
                
                if (imgIdx < gImageCount && newIdx > 0) {
                    var newElt = jQuery("img.inset[data-idx='" + newIdx + "']")[0];
                    jQuery(newElt).addClass("active").fadeIn(gEaseOut, function() {
                        setWaterLevel(newIdx, gEaseIn);    
                    });
                    jQuery(elt).removeClass("active").fadeOut(gEaseIn);
                }
                return false;
            });
            
            jQuery(window).bind("orientationchange", function (e, ui) {
                document.body.scrollTop = document.documentElement.scrollTop = 0;
                setWaterLevel();             
            });
            
            jQuery("#reset").click(function() {
                jQuery("img.inset").hide().removeClass("active");
                jQuery("img.inset[data-idx='1']").addClass("active").show();
                setWaterLevel(1);
            });
        });
    </script>
{% endblock %}


